{% if google_maps_api_key %}
<script>
  // Track if maps API is loaded
  window.mapsApiLoaded = window.mapsApiLoaded || false;
  
  // Function to load Google Maps API
  function loadGoogleMapsApi() {
    if (window.mapsApiLoaded) return;
    
    const script = document.createElement('script');
    script.src = "https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap";
    script.defer = true;
    script.async = true;
    script.onload = function() {
      window.mapsApiLoaded = true;
      // Dispatch event when API is loaded
      document.dispatchEvent(new Event('googleMapsLoaded'));
    };
    document.head.appendChild(script);
  }
  
  // Initialize map when page loads
  document.addEventListener('DOMContentLoaded', loadGoogleMapsApi);
  
  // Handle navigation with browser back/forward buttons
  window.addEventListener('pageshow', function(event) {
    // Force map reinitialization if returning from cache
    if (event.persisted) {
      initMap();
    }
  });
</script>
{% endif %}